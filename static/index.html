<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Online Banking - Account</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav>
    <h1>My Online Bank</h1>
    <div class="nav-buttons">
      <button class="nav-btn is-current" id="nav-account" onclick="window.location.href='index.html'">Accounts</button>
      <button class="nav-btn" id="nav-paybill" onclick="window.location.href='pay_bill/pay_bill.html'">Pay Bills</button>
      <button class="nav-btn" id="nav-transfer" onclick="window.location.href='etransfer/etransfer.html'">e-Transfer</button>
      <button class="nav-btn" id="nav-services" onclick="window.location.href='services.html'">Bank Services</button>
      <button class="nav-btn" id="nav-profile" onclick="window.location.href='profile.html'">Profile & Settings</button>
    </div>
  </nav>
  <div class="accounts-section">
    <div class="section-head">
      <h2 class="h2">My Accounts</h2>
      <button class="print-btn" onclick="window.print()" aria-label="Print">
        <span class="print-icon" aria-hidden="true"></span> PRINT
      </button>
    </div>

    <section class="stack">
      <article class="account-card">
        <div class="account-card__title">Chequing Account</div>
        <div class="account-card__meta">5438</div>
        <div class="account-card__balance positive">$3,542.30</div>
        <button class="link-btn view_activity" id="view_checking_activity"
                onclick="window.location.href='statement/chequing_activity.html'">
          View Activity
        </button>
      </article>

      <article class="account-card">
        <div class="account-card__title">Savings Account</div>
        <div class="account-card__meta">4320</div>
        <div class="account-card__balance positive">$12,874.10</div>
        <button class="link-btn view_activity" id="view_saving_activity"
                onclick="window.location.href='statement/savings_activity.html'">
          View Activity
        </button>
      </article>

      <article class="account-card">
        <div class="account-card__title">Credit Card</div>
        <div class="account-card__meta">4126</div>
        <div class="account-card__balance positive">$125.00</div>
        <button class="link-btn"
                onclick="window.location.href='statement/credit_activity.html'">
          View Activity
        </button>
      </article>

      <!-- Quick links card -->
      <article class="account-card">
        <a class="quicklink" href="#">
          <!-- <span class="quicklink-icon">üìÖ</span> -->
          Book or Manage Appointments
        </a>
        <a class="quicklink" href="#">
          <!-- <span class="quicklink-icon">üìç</span> -->
          Locate an ATM or branch
        </a>
        <a class="quicklink" href="#">
          <!-- <span class="quicklink-icon">‚úâÔ∏è</span> -->
          Send us a message
        </a>
      </article>
    </section>
  </div>

  <iframe src="tutorbot.html" class="chatbot-frame"></iframe>
  <!-- <iframe src="tellerbot.html" class="chatbot-frame"></iframe> -->

<script>
  let lastHighlightedSelector = null;
  let assistant = "grace"; // Default assistant

  window.addEventListener("message", (event) => {
    // üîπ First handle assistant assignment
    if (event.data?.instruction === "sendAssistant" && event.data.assistant) {
      assistant = event.data.assistant;
      sessionStorage.setItem("assistant", assistant);
      console.log("‚úÖ Assistant set to:", assistant);
      return;  // ‚úÖ Important: stop further processing for this message
    }

    // Ignore messages not from your iframe
    if (!event.data || typeof event.data !== "object") return;
    if (!("instruction" in event.data)) return;

    const { selector, instruction, value } = event.data;
    console.log("Received message from chatbot:", selector, instruction, value);
    if (typeof selector !== "string" || typeof instruction !== "string") return;

    lastHighlightedSelector = selector;
    const elements = document.querySelectorAll(selector);

    if (instruction === "highlight") {
      elements.forEach(el => el.classList.add("highlight"));
    }
    if (instruction === "mark-complete") {
      elements.forEach(el => el.classList.remove("highlight"));
    }
    if (instruction === "fill") {
      elements.forEach(el => {
        if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
          el.value = value || "";
          el.dispatchEvent(new Event("input", { bubbles: true }));
          el.dispatchEvent(new Event("change", { bubbles: true }));
        }
      });
    }
    if (instruction === "select") {
      elements.forEach(el => {
        if (el.tagName === "SELECT") {
          el.value = value || "";
          el.dispatchEvent(new Event("change", { bubbles: true }));
        }
      });
    }
    if (instruction === "click") {
        elements.forEach(el => {
          const event = new MouseEvent("click", {
            bubbles: true,
            cancelable: true,
            view: window
          });
          el.dispatchEvent(event);
        });
    }
    if (instruction === "submit") {
      elements.forEach(el => {
        if (el.tagName === "FORM") {
          el.submit();
        }
      });
    }
  });

  document.addEventListener("click", (e) => {
    console.log("Clicked element on index.html:", e.target);
    if (!lastHighlightedSelector) return;

    const elements = document.querySelectorAll(lastHighlightedSelector);
    for (const el of elements) {
      if (el === e.target || el.contains(e.target)) {
        const chatbotIframe = document.querySelector("iframe");
        const clickedText = el.innerText?.trim() || el.value || el.id || "an element"; // fallback

        let msg;
        console.log("Current assistant", assistant)
        if (assistant.toLowerCase() === "frank") {
          msg = `‚úÖ I clicked "${clickedText}" for you`;
        } else if (assistant.toLowerCase() === "grace") {
          msg = `‚úÖ You clicked "${clickedText}"`;
        } else {
          msg = ``; // fallback/default
        }

        console.log("msg in parent", msg)

        chatbotIframe.contentWindow.postMessage({
          instruction: "log",
          text: msg
        }, "*");

        break; // stop after first match
      }
    }
  });
</script>
</html>
