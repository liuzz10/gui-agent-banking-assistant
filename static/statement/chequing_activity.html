<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chequing Activity</title>
  <link rel="stylesheet" href="../styles.css">
  <script defer src="download_statement.js"></script>
</head>
<body>
  <nav>
    <h1>My Online Bank</h1>
    <div class="nav-buttons">
      <button onclick="window.location.href='../index.html'">Accounts</button>
      <button onclick="window.location.href='../pay_bill/pay_bill.html'">Pay Bills</button>
      <button onclick="window.location.href='../etransfer/etransfer.html'">e-Transfer</button>
      <button class="nav-btn" id="nav-services" onclick="window.location.href='services.html'">Bank Services</button>
      <button class="nav-btn" id="nav-profile" onclick="window.location.href='../profile/profile.html'">Profile & Settings</button>
    </div>
  </nav>

  <div class="accounts-section content chequing-page">

    <!-- Page title row -->
    <div class="page-title">
      <h2 class="page-title__text">Primary Chequing Account 38792 2561-5438</h2>
      <button class="action-link" onclick="window.print()">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 9V3h12v6M6 17H4a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-2" fill="none" stroke="currentColor" stroke-width="1.6"/>
          <path d="M7 17h10v4H7zM6 13h1" fill="none" stroke="currentColor" stroke-width="1.6"/>
        </svg>
        PRINT
      </button>
    </div>

    <!-- Balance summary card -->
    <section class="card balance-card">
      <div class="balance-card__row balance-card__row--top">
        <div class="metric">
          <div class="metric__label">Current balance</div>
          <div class="metric__value">$3,542.30</div>
        </div>
      </div>

      <hr class="card-sep" />

      <div class="balance-card__row">
        <div class="metric">
          <div class="metric__label">Available balance</div>
          <div class="metric__value">$3,542.30</div>
        </div>
        <div class="metric">
          <div class="metric__label">Funds on hold</div>
          <div class="metric__value">$0.00</div>
        </div>

        <div class="quick-actions">
          <a class="quick-action" href="#">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 4v4m0 8v4m8-8h-4M8 12H4" fill="none" stroke="currentColor" stroke-width="1.6" />
            </svg>
            View Pre-authorized Debits
          </a>
          <a class="quick-action" href="#">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 3h10v6H7zM5 9h14v10H5zM9 13h6" fill="none" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            Download Void Cheque
          </a>
        </div>
      </div>
    </section>

    <!-- Transactions header row -->
    <div class="section-head">
      <h3 class="section-head__title">Transactions</h3>
      <button class="action-link" id="chequing-statement-download" onclick="downloadStatement('chequing-table','chequing_statement.csv')">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3v12m0 0l-4-4m4 4l4-4M4 19h16" fill="none" stroke="currentColor" stroke-width="1.6"/>
        </svg>
        DOWNLOAD
      </button>
      <!-- <button class="button button-primary" id="chequing-statement-download" onclick="downloadStatement('chequing-table', 'chequing_statement.csv')">Download Statement</button> -->
    </div>

    <!-- Transactions card -->
    <section class="card tx-card">
      <!-- filter bar -->
      <div class="tx-filter">
        <span class="tx-filter__lead">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 6h16M6 12h12M10 18h4" fill="none" stroke="currentColor" stroke-width="1.8"/>
          </svg>
          FILTER
        </span>
        <span class="tx-filter__showing">Showing:</span>
        <span class="chip">30 days</span>
        <span class="chip chip--muted">All transactions</span>
      </div>

      <!-- table -->
      <div class="table-wrap">
        <table class="tx-table" id="chequing-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Money out</th>
              <th>Money in</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>August 08, 2025</td>
              <td>GAS</td>
              <td class="neg">- $100.00</td>
              <td></td>
              <td>$3542.30</td>
            </tr>
            <tr>
              <td>August 05, 2025</td>
              <td>GROCERIES</td>
              <td class="neg">- $100.00</td>
              <td></td>
              <td>$3642.30</td>
            </tr>
            <tr>
              <td>August 03, 2025</td>
              <td>CREDIT CARD CASHBACK</td>
              <td></td>
              <td class="pos">+ $50.00</td>
              <td>$3742.30</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <iframe src="../tutorbot.html" class="chatbot-frame"></iframe>
  <!-- <iframe src="../tellerbot.html" class="chatbot-frame"></iframe> -->
</body>

<script>
  let lastHighlightedSelector = null;
  let assistant = "grace"; // Default assistant

  window.addEventListener("message", (event) => {
      // ðŸ”¹ First handle assistant assignment
      if (event.data?.instruction === "sendAssistant" && event.data.assistant) {
      assistant = event.data.assistant;
      sessionStorage.setItem("assistant", assistant);
      console.log("âœ… Assistant set to:", assistant);
      return;  // âœ… Important: stop further processing for this message
      }

      // Basic guards
      if (!event.data || typeof event.data !== "object") return;
      if (!("instruction" in event.data)) return;

      const { selector, instruction, value } = event.data;
      console.log("Received message from chatbot:", selector, instruction, value);
      if (typeof instruction !== "string") return;

      // ðŸ”™ Handle global navigation actions (no selector required)
      if (instruction === "navigate") {
        if (value === "back") window.history.back();
        else if (value === "forward") window.history.forward();
        else if (value === "reload") window.location.reload();
        return; // nothing else to do
      }

      // For the rest, selector is expected; bail if it's not a string
      if (typeof selector !== "string") return;

      lastHighlightedSelector = selector;
      const elements = document.querySelectorAll(selector);

      if (instruction === "highlight") {
      elements.forEach(el => el.classList.add("highlight"));
      }
      if (instruction === "mark-complete") {
      elements.forEach(el => el.classList.remove("highlight"));
      }
      if (instruction === "fill") {
      elements.forEach(el => {
          if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
          el.value = value || "";
          el.dispatchEvent(new Event("input", { bubbles: true }));
          el.dispatchEvent(new Event("change", { bubbles: true }));
          }
      });
      }
      if (instruction === "select") {
      elements.forEach(el => {
          if (el.tagName === "SELECT") {
          el.value = value || "";
          el.dispatchEvent(new Event("change", { bubbles: true }));
          }
      });
      }
      if (instruction === "click") {
          elements.forEach(el => {
          const event = new MouseEvent("click", {
              bubbles: true,
              cancelable: true,
              view: window
          });
          el.dispatchEvent(event);
          });
      }
      if (instruction === "submit") {
      elements.forEach(el => {
          if (el.tagName === "FORM") {
          el.submit();
          }
      });
      }
  });

  document.addEventListener("click", (e) => {
      console.log("Clicked element on index.html:", e.target);
      if (!lastHighlightedSelector) return;

      const elements = document.querySelectorAll(lastHighlightedSelector);
      for (const el of elements) {
      if (el === e.target || el.contains(e.target)) {
          const chatbotIframe = document.querySelector("iframe");
          const clickedText = el.innerText?.trim() || el.value || el.id || "an element"; // fallback

          let msg;
          console.log("Current assistant", assistant)
          if (assistant.toLowerCase() === "frank") {
          msg = `âœ… I clicked "${clickedText}" for you`;
          } else if (assistant.toLowerCase() === "grace") {
          console.log("Current assistant", assistant)
          msg = `âœ… You clicked "${clickedText}"`;
          } else {
          msg = ``; // fallback/default
          }

          chatbotIframe.contentWindow.postMessage({
          instruction: "log",
          text: msg
          }, "*");

          break; // stop after first match
      }
      }
  });
</script>
</html>